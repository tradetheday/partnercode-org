---
import LanguageSwitcher from './LanguageSwitcher.astro';
import ThemeToggle from './ThemeToggle.astro';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props;

// Import translation dynamically
const translations = await import(`../data/translations/${lang}.json`);
const t = translations.default || translations;

function getLocalizedPath(path: string): string {
  if (lang === 'en') return path;
  return `/${lang}${path}`;
}
---

<header class="header">
  <div class="container">
    <div class="header__inner">
      <a href={getLocalizedPath('/')} class="header__logo">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" rx="8" fill="currentColor" class="logo-bg"/>
          <path d="M8 16L14 10L20 16L14 22L8 16Z" fill="white"/>
          <path d="M14 16L20 10L26 16L20 22L14 16Z" fill="white" fill-opacity="0.6"/>
        </svg>
        <span class="header__logo-text">PartnerCode</span>
      </a>

      <nav class="header__nav">
        <a href={getLocalizedPath('/avatrade/')} class="header__link">
          {t.nav?.avatrade || 'AvaTrade'}
        </a>
        <a href={getLocalizedPath('/xm/')} class="header__link">
          {t.nav?.xm || 'XM'}
        </a>
        <a href={getLocalizedPath('/avafutures/')} class="header__link">
          {t.nav?.avafutures || 'AvaFutures'}
        </a>
        <a href={getLocalizedPath('/exness/')} class="header__link">
          {t.nav?.exness || 'Exness'}
        </a>
      </nav>

      <div class="header__actions">
        <LanguageSwitcher lang={lang} />
        <ThemeToggle />
        <button class="header__menu-btn" aria-label="Menu" aria-expanded="false">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</header>

<style>
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
  }

  .header__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    position: relative;
  }

  .header__logo {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    text-decoration: none;
    color: var(--color-text);
    flex-shrink: 0;
  }

  .header__logo:hover {
    text-decoration: none;
  }

  .header__logo .logo-bg {
    color: var(--color-primary-600);
  }

  .header__logo-text {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-primary-900);
  }

  .header__nav {
    display: none;
    align-items: center;
    justify-content: center;
    gap: var(--space-6);
  }

  @media (min-width: 768px) {
    .header__nav {
      display: flex;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
  }

  .header__link {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .header__link:hover {
    color: var(--color-primary-600);
    text-decoration: none;
  }

  .header__link--cta {
    padding: var(--space-2) var(--space-4);
    background: var(--color-primary-600);
    color: #fff;
    border-radius: var(--radius-md);
  }

  .header__link--cta:hover {
    background: var(--color-primary-700);
    color: #fff;
  }

  .header__actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
  }

  .header__actions :global(.lang-switcher) {
    display: none;
  }

  @media (min-width: 768px) {
    .header__actions :global(.lang-switcher) {
      display: block;
    }
  }

  .header__menu-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-2);
    background: transparent;
    border: none;
    color: var(--color-text);
    cursor: pointer;
  }

  @media (min-width: 768px) {
    .header__menu-btn {
      display: none;
    }
  }

  /* Mobile menu styles */
  @media (max-width: 767px) {
    .header__nav.mobile-open {
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 64px;
      left: 0;
      right: 0;
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4);
      gap: var(--space-2);
      box-shadow: var(--shadow-lg);
    }

    .header__nav.mobile-open .header__link {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
    }

    .header__nav.mobile-open .header__link:hover,
    .header__nav.mobile-open .header__link:focus {
      background: var(--color-bg-secondary);
    }
  }
</style>

<script>
  const menuBtn = document.querySelector('.header__menu-btn') as HTMLButtonElement;
  const nav = document.querySelector('.header__nav') as HTMLElement;

  if (menuBtn && nav) {
    const focusableElements = nav.querySelectorAll('a, button') as NodeListOf<HTMLElement>;
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];

    function openMenu() {
      menuBtn.setAttribute('aria-expanded', 'true');
      nav.classList.add('mobile-open');
      // Focus first menu item after opening
      setTimeout(() => firstFocusable?.focus(), 10);
    }

    function closeMenu() {
      menuBtn.setAttribute('aria-expanded', 'false');
      nav.classList.remove('mobile-open');
      menuBtn.focus();
    }

    function isMenuOpen() {
      return nav.classList.contains('mobile-open');
    }

    menuBtn.addEventListener('click', () => {
      if (isMenuOpen()) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMenuOpen()) {
        closeMenu();
      }
    });

    // Focus trap within mobile menu
    nav.addEventListener('keydown', (e) => {
      if (!isMenuOpen() || e.key !== 'Tab') return;

      if (e.shiftKey && document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable?.focus();
      } else if (!e.shiftKey && document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable?.focus();
      }
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (isMenuOpen() && !nav.contains(target) && !menuBtn.contains(target)) {
        closeMenu();
      }
    });
  }
</script>
