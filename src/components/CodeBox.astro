---
interface Props {
  code: string;
  label?: string;
  copyText?: string;
  copiedText?: string;
  targetUrl?: string;
}

const {
  code,
  label = 'Partner Code',
  copyText = 'Copy',
  copiedText = 'Copied!',
  targetUrl
} = Astro.props;
---

<div class="code-box">
  <span class="code-box__label">{label}</span>
  <div class="code-box__code">
    <span class="code-box__value">{code}</span>
    <button
      class="code-box__copy"
      data-copy={code}
      data-copy-text={copyText}
      data-copied-text={copiedText}
      data-target-url={targetUrl}
      aria-label={`Copy code ${code} and open registration`}
    >
      <span class="code-box__copy-text">{copyText}</span>
      <svg class="code-box__check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </button>
  </div>
</div>

<script>
  async function copyToClipboard(text: string): Promise<boolean> {
    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        // Fall through to fallback
      }
    }

    // Fallback for older browsers
    try {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      textArea.style.top = '-9999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textArea);
      return success;
    } catch {
      return false;
    }
  }

  function initCopyButtons() {
    document.querySelectorAll('.code-box__copy').forEach((button) => {
      button.addEventListener('click', async (e) => {
        const btn = e.currentTarget as HTMLButtonElement;

        // Prevent double-clicks while processing
        if (btn.classList.contains('copied')) return;

        const code = btn.dataset.copy || '';
        const copyText = btn.dataset.copyText || 'Copy';
        const copiedText = btn.dataset.copiedText || 'Copied!';
        const targetUrl = btn.dataset.targetUrl;

        const textSpan = btn.querySelector('.code-box__copy-text') as HTMLSpanElement;

        // Copy to clipboard
        const success = await copyToClipboard(code);

        if (success) {
          // Update UI to show "Copied!" with checkmark
          btn.classList.add('copied');
          if (textSpan) textSpan.textContent = copiedText;

          // After 300ms delay, open the URL in a new tab
          if (targetUrl) {
            setTimeout(() => {
              window.open(targetUrl, '_blank', 'noopener');
            }, 300);
          }

          // After 3 seconds, reset the UI
          setTimeout(() => {
            btn.classList.remove('copied');
            if (textSpan) textSpan.textContent = copyText;
          }, 3000);
        }
      });
    });
  }

  // Initialize on page load
  initCopyButtons();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initCopyButtons);
</script>

<style>
  .code-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-8);
    background: linear-gradient(135deg, var(--color-primary-900), var(--color-primary-800));
    border-radius: var(--radius-2xl);
    text-align: center;
    box-shadow: var(--shadow-xl);
  }

  .code-box__label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-primary-300);
  }

  .code-box__code {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-6);
    background: rgba(255, 255, 255, 0.1);
    border: 2px dashed var(--color-accent-400);
    border-radius: var(--radius-xl);
  }

  .code-box__value {
    font-family: var(--font-mono);
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--color-accent-400);
    letter-spacing: 0.15em;
  }

  @media (min-width: 768px) {
    .code-box__value {
      font-size: var(--text-5xl);
    }
  }

  .code-box__copy {
    padding: var(--space-2) var(--space-4);
    background: var(--color-accent-500);
    color: #fff;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .code-box__copy:hover {
    background: var(--color-accent-600);
  }

  .code-box__copy:focus-visible {
    outline: 2px solid #fff;
    outline-offset: 2px;
  }

  .code-box__copy.copied {
    background: var(--color-success-600);
  }

  .code-box__copy-text {
    transition: opacity var(--transition-fast);
  }

  .code-box__check {
    display: none;
    width: 14px;
    height: 14px;
  }

  .code-box__copy.copied .code-box__check {
    display: inline-block;
    margin-left: var(--space-1);
  }
</style>
