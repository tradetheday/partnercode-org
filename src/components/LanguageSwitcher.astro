---
import { languages } from '../data/languages';

interface Props {
  lang?: string;
}

const { lang = 'en' } = Astro.props;

const currentLang = languages.find(l => l.code === lang) || languages[0];

// Get current path without language prefix to use for switching
const currentPath = Astro.url.pathname;
const pathWithoutLang = currentPath.replace(/^\/[a-z]{2}(-[A-Z]{2})?\//, '/').replace(/^\/[a-z]{2}(-[A-Z]{2})?$/, '/');

function getLanguagePath(langCode: string): string {
  if (langCode === 'en') {
    return pathWithoutLang || '/';
  }
  return `/${langCode}${pathWithoutLang === '/' ? '' : pathWithoutLang}`;
}
---

<div class="lang-switcher">
  <button class="lang-switcher__trigger" aria-expanded="false" aria-haspopup="listbox" aria-label={`Select language, current: ${currentLang.nativeName}`}>
    <span class="lang-switcher__current" aria-hidden="true">{currentLang.code.toUpperCase()}</span>
    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M3 5L6 8L9 5"/>
    </svg>
  </button>

  <ul class="lang-switcher__dropdown" role="listbox" aria-label="Select language">
    {languages.map((language) => (
      <li role="option" aria-selected={language.code === lang}>
        <a
          href={getLanguagePath(language.code)}
          class:list={['lang-switcher__option', { 'active': language.code === lang }]}
          lang={language.code}
        >
          <span class="lang-switcher__code">{language.code.toUpperCase()}</span>
          <span class="lang-switcher__name">{language.nativeName}</span>
          <span class="lang-switcher__flag">{language.flag}</span>
        </a>
      </li>
    ))}
  </ul>
</div>

<style>
  .lang-switcher {
    position: relative;
  }

  .lang-switcher__trigger {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .lang-switcher__trigger:hover {
    border-color: var(--color-primary-500);
    color: var(--color-primary-600);
  }

  .lang-switcher__dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    z-index: 50;
    display: none;
    width: 180px;
    max-height: 300px;
    overflow-y: auto;
    margin-top: var(--space-2);
    padding: var(--space-2);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    list-style: none;
  }

  .lang-switcher.open .lang-switcher__dropdown {
    display: block;
  }

  .lang-switcher__option {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    transition: background var(--transition-fast);
  }

  .lang-switcher__option:hover {
    background: var(--color-bg-secondary);
    text-decoration: none;
  }

  .lang-switcher__option.active {
    background: var(--color-primary-50);
    color: var(--color-primary-700);
  }

  .lang-switcher__code {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--color-text-muted);
    min-width: 24px;
  }

  .lang-switcher__option.active .lang-switcher__code {
    color: var(--color-primary-600);
  }

  .lang-switcher__name {
    font-size: var(--text-sm);
    flex: 1;
  }

  .lang-switcher__flag {
    font-size: var(--text-base);
    margin-left: auto;
  }
</style>

<script>
  const switcher = document.querySelector('.lang-switcher');
  const trigger = document.querySelector('.lang-switcher__trigger') as HTMLButtonElement;
  const dropdown = document.querySelector('.lang-switcher__dropdown');
  const options = document.querySelectorAll('.lang-switcher__option') as NodeListOf<HTMLAnchorElement>;

  if (switcher && trigger && dropdown && options.length > 0) {
    let currentIndex = -1;

    function openDropdown() {
      switcher!.classList.add('open');
      trigger.setAttribute('aria-expanded', 'true');
      // Find currently active option
      currentIndex = Array.from(options).findIndex(opt => opt.classList.contains('active'));
      if (currentIndex === -1) currentIndex = 0;
      options[currentIndex].focus();
    }

    function closeDropdown() {
      switcher!.classList.remove('open');
      trigger.setAttribute('aria-expanded', 'false');
      currentIndex = -1;
      trigger.focus();
    }

    function focusOption(index: number) {
      if (index < 0) index = options.length - 1;
      if (index >= options.length) index = 0;
      currentIndex = index;
      options[currentIndex].focus();
    }

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      if (switcher.classList.contains('open')) {
        closeDropdown();
      } else {
        openDropdown();
      }
    });

    trigger.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (!switcher.classList.contains('open')) {
          openDropdown();
        }
      }
    });

    dropdown.addEventListener('keydown', (e) => {
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          focusOption(currentIndex + 1);
          break;
        case 'ArrowUp':
          e.preventDefault();
          focusOption(currentIndex - 1);
          break;
        case 'Home':
          e.preventDefault();
          focusOption(0);
          break;
        case 'End':
          e.preventDefault();
          focusOption(options.length - 1);
          break;
        case 'Escape':
          e.preventDefault();
          closeDropdown();
          break;
        case 'Tab':
          closeDropdown();
          break;
      }
    });

    document.addEventListener('click', (e) => {
      if (!switcher.contains(e.target as Node)) {
        closeDropdown();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && switcher.classList.contains('open')) {
        closeDropdown();
      }
    });
  }
</script>
