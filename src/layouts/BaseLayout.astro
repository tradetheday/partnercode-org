---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SocialProof from '../components/SocialProof.astro';
import { languages } from '../data/languages';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  lang?: string;
  canonicalPath?: string;
  ogImage?: string;
  noindex?: boolean;
  schema?: object;
}

const {
  title,
  description,
  lang = 'en',
  canonicalPath = '',
  ogImage = '/images/og-default.jpg',
  noindex = false,
  schema
} = Astro.props;

const site = 'https://partnercode.org';
const currentUrl = `${site}${canonicalPath}`;
const isRTL = lang === 'ar';
const langConfig = languages.find(l => l.code === lang) || languages[0];

// Generate hreflang URLs for all languages
function getHreflangUrl(langCode: string): string {
  // Get the base path by removing any existing language prefix
  // This handles both /es/avatrade/ and /avatrade/ formats
  let basePath = canonicalPath || '/';

  // Remove language prefix if present (handles /es/, /es, /de/avatrade/, etc.)
  basePath = basePath.replace(/^\/[a-z]{2}(\/|$)/, '/');

  // Ensure basePath starts with /
  if (!basePath.startsWith('/')) {
    basePath = '/' + basePath;
  }

  if (langCode === 'en') {
    // English is at root - just use the base path
    return `${site}${basePath}`;
  }

  // Other languages use subdirectories
  // For root path, return /es instead of /es/
  if (basePath === '/') {
    return `${site}/${langCode}`;
  }

  // For other paths, return /es/avatrade/ etc.
  return `${site}/${langCode}${basePath}`;
}

// Build canonical URL for current language
const canonicalUrl = lang === 'en'
  ? `${site}${canonicalPath || '/'}`
  : `${site}/${lang}${canonicalPath || ''}`;
---

<!DOCTYPE html>
<html lang={lang} dir={isRTL ? 'rtl' : 'ltr'}>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary Meta Tags -->
  <title>{title}</title>
  <meta name="title" content={title} />
  <meta name="description" content={description} />
  {noindex && <meta name="robots" content="noindex, follow" />}

  <!-- Canonical & Hreflang -->
  <link rel="canonical" href={canonicalUrl} />

  {languages.map((l) => (
    <link
      rel="alternate"
      hreflang={l.code}
      href={getHreflangUrl(l.code)}
    />
  ))}
  <link rel="alternate" hreflang="x-default" href={getHreflangUrl('en')} />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalUrl} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={`${site}${ogImage}`} />
  <meta property="og:locale" content={langConfig.locale} />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content={canonicalUrl} />
  <meta property="twitter:title" content={title} />
  <meta property="twitter:description" content={description} />
  <meta property="twitter:image" content={`${site}${ogImage}`} />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <!-- Fonts - optimized loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" /></noscript>

  <!-- RTL Styles -->
  {isRTL && <link rel="stylesheet" href="/src/styles/rtl.css" />}

  <!-- Schema.org JSON-LD -->
  {schema && (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  )}

  <!-- Organization Schema -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "PartnerCode.org",
      "url": "https://partnercode.org",
      "description": "Your trusted source for verified broker partner codes and welcome bonuses from regulated brokers like AvaTrade, XM, and Exness.",
      "logo": {
        "@type": "ImageObject",
        "url": "https://partnercode.org/favicon.svg"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer support",
        "url": "https://partnercode.org/about/"
      }
    }
  </script>

  <!-- WebSite Schema with SearchAction for Google sitelinks -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "PartnerCode.org",
      "url": "https://partnercode.org",
      "description": "Find verified partner codes for top forex and CFD brokers. Get exclusive welcome bonuses from AvaTrade, XM, Exness, and more.",
      "publisher": {
        "@type": "Organization",
        "name": "PartnerCode.org",
        "url": "https://partnercode.org"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://partnercode.org/?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    }
  </script>
</head>
<body>
  <Header lang={lang} />

  <main>
    <slot />
  </main>

  <Footer lang={lang} />

  <SocialProof lang={lang} />

  <!-- Copy to clipboard functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-copy]').forEach(button => {
        button.addEventListener('click', async () => {
          const code = button.getAttribute('data-copy');
          if (code) {
            try {
              await navigator.clipboard.writeText(code);
              button.classList.add('copied');
              const originalText = button.textContent;
              button.textContent = button.getAttribute('data-copied-text') || 'Copied!';
              setTimeout(() => {
                button.classList.remove('copied');
                button.textContent = originalText;
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
      });
    });
  </script>

  <!-- FAQ Toggle -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.faq-question').forEach(button => {
        button.addEventListener('click', () => {
          const item = button.closest('.faq-item');
          if (item) {
            const isOpen = item.classList.toggle('open');
            button.setAttribute('aria-expanded', isOpen.toString());
          }
        });
      });
    });
  </script>
</body>
</html>
