---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CodeBox from '../../components/CodeBox.astro';
import HowToSteps from '../../components/HowToSteps.astro';
import FAQ from '../../components/FAQ.astro';
import TrustBadges from '../../components/TrustBadges.astro';
import AvailabilityNotice from '../../components/AvailabilityNotice.astro';
import SEOSchema from '../../components/SEOSchema.astro';
import { avatrade } from '../../data/brokers';
import { languages, getNonEnglishLanguageCodes } from '../../data/languages';

export function getStaticPaths() {
  const langCodes = getNonEnglishLanguageCodes();
  return langCodes.map(lang => ({ params: { lang } }));
}

const { lang } = Astro.params;
const langConfig = languages.find(l => l.code === lang);

// Dynamic import of translation
const t = await import(`../../data/translations/${lang}.json`);
const translations = t.default || t;

// Use English fallback for homeFaq if not translated yet
const enT = await import('../../data/translations/en.json');
const enTranslations = enT.default || enT;
const homeFaq = translations.homeFaq || enTranslations.homeFaq;
const homeFaqTitle = translations.home?.faqTitle || enTranslations.home.faqTitle;

// Schema data
const breadcrumbSchema = {
  breadcrumbs: [
    { name: translations.nav?.home || 'Home', url: `https://partnercode.org/${lang}/` }
  ]
};

const webPageSchema = {
  pageTitle: translations.meta.homeTitle,
  pageDescription: translations.meta.homeDescription,
  pageUrl: `https://partnercode.org/${lang}/`,
  pageType: 'CollectionPage' as const,
  inLanguage: lang
};

const faqSchema = { faqs: homeFaq };
---

<BaseLayout
  title={translations.meta.homeTitle}
  description={translations.meta.homeDescription}
  lang={lang}
  canonicalPath={`/${lang}/`}
>
  <SEOSchema type="BreadcrumbList" data={breadcrumbSchema} />
  <SEOSchema type="WebPage" data={webPageSchema} />
  <SEOSchema type="FAQPage" data={faqSchema} />

  <!-- Availability Notice for restricted countries -->
  {langConfig && !langConfig.available && langConfig.availabilityNote && (
    <div class="container mt-4">
      <AvailabilityNotice
        available={false}
        message={langConfig.availabilityNote}
        type="warning"
      />
    </div>
  )}

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <div class="hero__content">
        <span class="badge badge-primary">{translations.home.badge}</span>
        <h1 class="hero__title">{translations.home.title}</h1>
        <p class="hero__subtitle">{translations.home.subtitle}</p>
        <a href={`/${lang}/avatrade/`} class="btn btn-primary btn-lg">{translations.home.cta}</a>
      </div>
    </div>
  </section>

  <!-- What is a Partner Code -->
  <section class="section bg-secondary">
    <div class="container">
      <div class="content-block">
        <h2>{translations.home.whatIs.title}</h2>
        <p>{translations.home.whatIs.p1}</p>
        <p>{translations.home.whatIs.p2}</p>
      </div>
    </div>
  </section>

  <!-- Featured Partner Code -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-header__title">{translations.home.featured.title}</h2>
      </div>

      <div class="featured-broker">
        <div class="featured-broker__info">
          <h3>{translations.home.featured.broker}</h3>
          <p class="featured-broker__bonus">{translations.home.featured.bonus}</p>
        </div>

        <CodeBox
          code={avatrade.partnerCode}
          label={translations.code.label}
          copyText={translations.code.copy}
          copiedText={translations.code.copied}
          targetUrl={avatrade.affiliateUrl}
        />

        <div class="featured-broker__cta">
          <a href={`/${lang}/avatrade/`} class="btn btn-primary btn-lg">{translations.home.featured.cta}</a>
        </div>
      </div>
    </div>
  </section>

  <!-- How Partner Codes Work -->
  <section class="section bg-secondary">
    <div class="container">
      <HowToSteps
        title={translations.howTo.title}
        steps={translations.howTo.steps}
      />
    </div>
  </section>

  <!-- Trust Badges -->
  <section class="section">
    <div class="container">
      <TrustBadges
        title={translations.trust.title}
        regulators={avatrade.regulators.slice(0, 4)}
      />
    </div>
  </section>

  <!-- FAQ -->
  <section class="section bg-secondary">
    <div class="container">
      <FAQ
        title={homeFaqTitle}
        items={homeFaq}
        generateSchema={false}
      />
    </div>
  </section>

  <!-- Final CTA -->
  <section class="section cta-section">
    <div class="container">
      <div class="cta-box">
        <h2>{translations.home.featured.title}</h2>
        <p>{translations.avatrade.subtitle}</p>
        <a href={`/${lang}/avatrade/`} class="btn btn-primary btn-lg">{translations.home.cta}</a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .content-block {
    max-width: 800px;
    margin: 0 auto;
  }

  .content-block h2 {
    margin-bottom: var(--space-6);
  }

  .featured-broker {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
  }

  .featured-broker__info {
    margin-bottom: var(--space-6);
  }

  .featured-broker__info h3 {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-2);
  }

  .featured-broker__bonus {
    font-size: var(--text-xl);
    color: var(--color-accent-600);
    font-weight: var(--font-semibold);
  }

  .featured-broker__cta {
    margin-top: var(--space-8);
  }

  .cta-section {
    background: linear-gradient(135deg, var(--color-primary-900), var(--color-primary-800));
    color: #fff;
  }

  .cta-box {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
  }

  .cta-box h2 {
    color: #fff;
    margin-bottom: var(--space-4);
  }

  .cta-box p {
    color: var(--color-primary-200);
    font-size: var(--text-lg);
    margin-bottom: var(--space-6);
  }
</style>
